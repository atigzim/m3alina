# 🎯 رسم توضيحي: رحلة الشعاع من اللاعب حتى الاصطدام

---

## 1️⃣ منظور الخريطة 2D (من الأعلى)

```
     0    1    2    3    4    5    6    7    8
   ┌────┬────┬────┬────┬────┬────┬────┬────┬────┐
0  │    │    │    │    │    │    │    │    │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
1  │    │ 1  │ 1  │ 1  │ 1  │ 1  │    │    │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
2  │    │ 1  │    │    │    │ 1  │    │ 1  │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
3  │    │ 1  │    │🎮  │    │ 1  │    │ 1  │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
4  │    │ 1  │    │ ✦  │    │ 1  │    │ 1  │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
5  │    │ 1  │    │ ✦  │    │ 1  │    │ 1  │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
6  │    │ 1  │    │ ✦  │    │ 1  │    │ 1  │    │
   ├────┼────┼────┼────┼────┼────┼────┼────┼────┤
7  │    │ 1  │ 1  │ 1  │ 1  │ 1  │    │ 1  │    │
   └────┴────┴────┴────┴────┴────┴────┴────┴────┘

🎮 = موقع اللاعب (3, 3)
1 = جدران
✦ = مسار الشعاع


حسابات الموقع:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
موقع اللاعب على الشاشة: x=100, y=100 (بيكسل)
موقع اللاعب على الخريطة: map_x=3, map_y=3

TILE_SIZE = 32 بيكسل
100 / 32 = 3.125 → 3 ✓
```

---

## 2️⃣ زوايا الأشعة (FOV - مجال الرؤية)

```
        زاوية اللاعب = 0° (ينظر لليمين)
        FOV = 60°

   -30°  -20°  -10°   0°   +10°  +20°  +30°
     \    \     \     |     /     /     /
      \    \     \    |    /     /     /
       \    \     \   |   /     /     /
        \    \     \  |  /     /     /
         \    \     \ | /     /     /
          🎮────────────────────────────→
         (اللاعب)


الشعاع 0 (الأول/اليساري):
  زاوية = 0° - 30° = -30°

الشعاع 600 (الأوسط):
  زاوية = 0° - 30° + (600 × 60°/1200) = 0°

الشعاع 1199 (الأخير/اليميني):
  زاوية = 0° - 30° + 60° = 30°
```

---

## 3️⃣ متابعة شعاع واحد خطوة بخطوة

### الشعاع رقم 600 (الشعاع الأوسط - ينظر بزاوية 0°)

```
TILE_SIZE = 32 بيكسل

     موقع اللاعب
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  الخريطة:
   3    4    5    6
  ┌────┬────┬────┬────┐
2 │    │    │    │    │
  ├────┼────┼────┼────┤
3 │    │🎮  │    │    │  ← اللاعب هنا
  ├────┼────┼────┼────┤
4 │    │    │    │    │
  ├────┼────┼────┼────┤
5 │    │    │    │ 1  │  ← جدار!
  └────┴────┴────┴────┘


خطوات الخوارزمية:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

1️⃣ حساب اتجاه الشعاع
   ────────────────────────
   زاوية الشعاع = 0°
   ray_dir_x = cos(0°) = 1.0  (يتحرك لليمين)
   ray_dir_y = sin(0°) = 0.0  (لا يتحرك عمودياً)


2️⃣ موقع اللاعب على الخريطة
   ────────────────────────
   اللاعب الفعلي: x=100, y=100 (بيكسل)
   على الخريطة:  map_x = 100/32 = 3
                 map_y = 100/32 = 3


3️⃣ حساب Delta Distance
   ────────────────────────
   delta_dist_x = fabs(1 / 1.0) = 1.0
   delta_dist_y = fabs(1 / 0.0) = ∞ (لا توجد حركة عمودية)


4️⃣ حساب Initial Side Distance
   ────────────────────────
   ray_dir_x > 0 (يذهب لليمين)
   step_x = 1

   خط الشبكة التالي = (map_x + 1) × 32 = 4 × 32 = 128
   مسافة = 128 - 100 = 28 بيكسل
   side_dist_x = 28 × 1.0 / 32 = 0.875

   ray_dir_y = 0 (لا حركة)
   side_dist_y = ∞


5️⃣ حلقة البحث عن الجدار (DDA)
   ────────────────────────

   الخطوة 1:
   ─────────
   side_dist_x = 0.875  }
   side_dist_y = ∞      } side_dist_x أصغر
   
   → اختر التقاطع العمودي
   side_dist_x += delta_dist_x = 0.875 + 1.0 = 1.875
   map_x += step_x = 3 + 1 = 4
   
   تحقق: map[3][4] = ' ' (فراغ) ✗ استمر...


   الخطوة 2:
   ─────────
   side_dist_x = 1.875  }
   side_dist_y = ∞      } side_dist_x أصغر
   
   → اختر التقاطع العمودي
   side_dist_x += delta_dist_x = 1.875 + 1.0 = 2.875
   map_x += step_x = 4 + 1 = 5
   
   تحقق: map[3][5] = ' ' (فراغ) ✗ استمر...


   الخطوة 3:
   ─────────
   side_dist_x = 2.875  }
   side_dist_y = ∞      } side_dist_x أصغر
   
   → اختر التقاطع العمودي
   side_dist_x += delta_dist_x = 2.875 + 1.0 = 3.875
   map_x += step_x = 5 + 1 = 6
   
   تحقق: map[3][6] = '1' (جدار!) ✓ وجدنا!
   hit = 1
   side = 0 (تقاطع عمودي)


6️⃣ حساب المسافة
   ────────────────────────
   perp_wall_dist = (side_dist_x - delta_dist_x) × TILE_SIZE
                  = (3.875 - 1.0) × 32
                  = 2.875 × 32
                  = 92 بيكسل

   ray->distance = 92


7️⃣ تصحيح التشويه السمكي
   ────────────────────────
   corrected_dist = distance × cos(ray_angle - player_angle)
                  = 92 × cos(0° - 0°)
                  = 92 × cos(0°)
                  = 92 × 1.0
                  = 92 بيكسل
   
   (بدون تصحيح لأن الشعاع مركزي)


8️⃣ حساب ارتفاع الجدار
   ────────────────────────
   distance_to_plane = (1200/2) / tan(30°)
                     = 600 / 0.577
                     ≈ 1039.2

   wall_height = (32 / 92) × 1039.2
               = 0.348 × 1039.2
               ≈ 361 بيكسل


9️⃣ تحديد موقع الرسم
   ────────────────────────
   wall_start = (800/2) - (361/2)
              = 400 - 180.5
              ≈ 219

   wall_end = (800/2) + (361/2)
            = 400 + 180.5
            ≈ 580


🔟 رسم العمود
   ────────────────────────
   ارسم من y=219 إلى y=580 عند x=600
   بيكسل يلو اللون 0xAAAAAA (رمادي)
```

---

## 4️⃣ رسم الشعاع على الشاشة (3D)

```
الشاشة النهائية:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

     السقف (أزرق سماوي - 0x87CEEB)
     ┌─────────────────────────────────┐
     │                                 │
     │   y = 0 إلى 219                 │
     │                                 │
     ├──────────────┬──────────────────┤
     │              │   █████████████   │
     │              │   █████████████   │  ارتفاع الجدار
     │    جدران     │   █████████████   │  = 361 بيكسل
     │   أخرى       │   █████████████   │  (من 219 إلى 580)
     │              │   █████████████   │
     ├──────────────┴──────────────────┤
     │                                 │
     │   y = 581 إلى 800               │
     │                                 │
     │      الأرضية (بني - 0x78461E)   │
     └─────────────────────────────────┘
     
     x=0              x=600            x=1200
     الشعاع الأول     الشعاع الأوسط     الشعاع الأخير
```

---

## 5️⃣ جميع الأشعة معاً (1200 شعاع)

```
نظرة المستخدم:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

كل شعاع ينتج عمود بارتفاع مختلف

الشعاع 0:      الشعاع 600:    الشعاع 1199:
(يساري)        (أوسط)         (يميني)

▌▌▌▌▌▌▌▌      ▌▌▌▌▌▌▌▌      ▌▌▌▌▌▌▌▌
▌▌▌▌▌▌▌▌      ▌▌▌▌▌▌▌▌      ▌▌▌▌▌▌▌▌
  ▌▌▌▌▌        ▌▌▌▌▌▌▌▌        ▌▌▌▌▌
    ▌▌▌        ▌▌▌▌▌▌▌▌        ▌▌▌
      ▌        ▌▌▌▌▌▌▌▌        ▌


نتيجة النهاية: صورة 3D!

        السقف
    ┌─────────────┐
    │    ╱╲╱╲    │  ← جدران بارتفاعات مختلفة
    │   ╱  ╲  ╲   │     تمثل المنظور 3D
    │  ╱    ╲  ╲  │
    ├─────────────┤
    │             │
    │   الأرضية   │
    └─────────────┘
```

---

## 6️⃣ شعاع بزاوية 45° (مثال آخر)

```
زاوية الشعاع = 45°

ray_dir_x = cos(45°) = 0.707
ray_dir_y = sin(45°) = 0.707

الشعاع يتحرك قطرياً:


     0    1    2    3    4    5    6
   ┌────┬────┬────┬────┬────┬────┬────┐
0  │    │    │    │    │    │    │    │
   ├────┼────┼────┼────┼────┼────┼────┤
1  │    │    │    │    │    │    │    │
   ├────┼────┼────┼────┼────┼────┼────┤
2  │    │    │    │    │    │    │ 1  │
   ├────┼────┼────┼────┼────┼────┼────┤
3  │    │    │    │🎮  │ ✦  │ ✦  │ 1  │  ← اللاعب
   ├────┼────┼────┼────┼────┼────┼────┤
4  │    │    │    │ ✦  │ ✦  │ 1  │ 1  │
   ├────┼────┼────┼────┼────┼────┼────┤
5  │    │    │ ✦  │ ✦  │ 1  │ 1  │ 1  │
   ├────┼────┼────┼────┼────┼────┼────┤
6  │    │ ✦  │ 1  │ 1  │ 1  │ 1  │ 1  │
   └────┴────┴────┴────┴────┴────┴────┘


الشعاع يتحرك:
- يميناً (ray_dir_x = 0.707)
- أسفل (ray_dir_y = 0.707)

حتى يصطدم بالجدار في (2, 6)
```

---

## 7️⃣ تأثير المسافة على ارتفاع الجدار

```
الشعاع الأول (يسار):        الشعاع الأوسط (مركز):
مسافة = 50 بيكسل          مسافة = 92 بيكسل

ارتفاع = (32/50)×1039.2   ارتفاع = (32/92)×1039.2
       = 665 بيكسل               = 361 بيكسل


        الشعاع الأخير (يمين):
        مسافة = 150 بيكسل

        ارتفاع = (32/150)×1039.2
               = 221 بيكسل


النتيجة النهائية على الشاشة:
┌──────────────────────────────────┐
│     ▌          ▌               ▌ │  السقف
│    ▌▌         ▌▌              ▌▌ │
│   ▌▌▌        ▌▌▌             ▌▌▌│
│  ▌▌▌▌       ▌▌▌▌            ▌▌▌▌│
│ ▌▌▌▌▌      ▌▌▌▌▌           ▌▌▌▌▌│
├─────────────────────────────────┤
│ ▌▌▌▌▌      ▌▌▌▌▌           ▌▌▌▌▌│
│  ▌▌▌▌       ▌▌▌▌            ▌▌▌▌│
│   ▌▌▌        ▌▌▌             ▌▌▌│
│    ▌▌         ▌▌              ▌▌ │
│     ▌          ▌               ▌ │  الأرضية
└──────────────────────────────────┘

     أقرب        أبعد        أبعد
```

---

## 8️⃣ التشويه السمكي قبل وبعد التصحيح

```
بدون تصحيح (Fish-Eye):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

الأشعة الجانبية تبدو أطول:

┌──────────────────────────┐
│ ▌                        ▌ │
│ ▌▌                      ▌▌ │
│  ▌▌                    ▌▌  │
│   ▌▌                  ▌▌   │
│    ▌▌▌              ▌▌▌    │
├────────────────────────────┤
│    ▌▌▌              ▌▌▌    │
│   ▌▌                  ▌▌   │
│  ▌▌                    ▌▌  │
│ ▌▌                      ▌▌ │
│ ▌                        ▌ │
└──────────────────────────┘

الجدار يبدو مقعراً! 😕


مع التصحيح (Fish-Eye Correction):
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌──────────────────────────┐
│  ▌                      ▌ │
│  ▌▌                    ▌▌ │
│  ▌▌▌                  ▌▌▌ │
│  ▌▌▌▌                ▌▌▌▌ │
│  ▌▌▌▌▌              ▌▌▌▌▌ │
├────────────────────────────┤
│  ▌▌▌▌▌              ▌▌▌▌▌ │
│  ▌▌▌▌                ▌▌▌▌ │
│  ▌▌▌                  ▌▌▌ │
│  ▌▌                    ▌▌ │
│  ▌                      ▌ │
└──────────────────────────┘

الجدار يبدو مسطحاً! ✓
```

---

## 9️⃣ رحلة الشعاع الكاملة (خريطة فعلية)

```
خريطة اللعبة:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

┌─────────────────────────────────────┐
│ 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 │
│ 1                                 1 │
│ 1                                 1 │
│ 1           🎮 ray                1 │
│ 1             ╱│╲                 1 │
│ 1            ╱ │ ╲                1 │
│ 1           ╱  │  ╲               1 │
│ 1          ╱   │   ╲              1 │
│ 1         ╱    │    ╲             1 │
│ 1        ╱     │     ╲            1 │
│ 1       ╱      │      ╲           1 │
│ 1      ╱       │       ╲          1 │
│ 1 ────────────────────────────────1 │
│ 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 │
└─────────────────────────────────────┘

🎮 = اللاعب
╱╲ = مجال الرؤية (60°)
ray = شعاع واحد من الـ 1200


مسار الشعاع الأوسط:
1. ينطلق من اللاعب بزاوية 0°
2. يتحرك بـ (cos(0°), sin(0°)) = (1, 0)
3. يتابع محور X لليمين
4. يقطع خطوط الشبكة: x=4, x=5, x=6...
5. يصطدم بالجدار السفلي
6. يحسب المسافة = 92 بيكسل
7. يرسم عمود بارتفاع 361 بيكسل
```

---

## 🔟 ملخص العملية

```
INPUT (المدخل):
━━━━━━━━━━━━━━━━━━━━━
• موقع اللاعب: (100, 100)
• زاوية اللاعب: 0° (ينظر لليمين)
• مجال الرؤية: 60°

PROCESS (العملية):
━━━━━━━━━━━━━━━━━━━━━
1. ينشئ 1200 شعاع
2. كل شعاع بزاوية مختلفة
3. لكل شعاع:
   - حساب الاتجاه
   - بحث عن أقرب جدار (DDA)
   - حساب المسافة
   - تصحيح التشويه السمكي
   - حساب الارتفاع
   - رسم عمود

OUTPUT (المخرج):
━━━━━━━━━━━━━━━━━━━━━
صورة 3D على الشاشة:
┌──────────────────────┐
│      السقف           │
│  ╱  ╱  ╱  ╱  ╱  ╱  │
│  ╱  ╱  ╱  ╱  ╱  ╱  │
│───────────────────── │
│  ╲  ╲  ╲  ╲  ╲  ╲  │
│  ╲  ╲  ╲  ╲  ╲  ╲  │
│     الأرضية         │
└──────────────────────┘
```

---

## معادلات مهمة

```
1. حساب الاتجاه:
   ray_dir_x = cos(angle)
   ray_dir_y = sin(angle)

2. Delta Distance:
   delta_dist = 1 / ray_dir

3. ارتفاع الجدار:
   height = (TILE_SIZE / distance) × (width/2) / tan(FOV/2)

4. تصحيح السمكة:
   corrected_distance = distance × cos(ray_angle - player_angle)

5. موقع الرسم:
   start = (height / 2) - (height / 2) = center - half_height
   end = (height / 2) + (height / 2) = center + half_height
```

---

هذا هو الشرح المفصل لرحلة الشعاع من اللاعب حتى الاصطدام! 🎮✨
